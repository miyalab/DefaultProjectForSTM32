/*
 * Copyright (c) 2020 K.Miyauchi
 * This software is released under the MIT LICENSE
 * http://opensource.org/licenses/mit-license.php
 *
 * File  : OSL.h
 * Author: Koshiro Miyauchi
 *
 * Version : 1.00
 */

#ifndef OSL_STM32F446_H_
#define OSL_STM32F446_H_

//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// �C���N���[�h
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#include <sys/_stdint.h>

//============================================================================================
// Open Source Library
//============================================================================================
namespace OSL{
	//****************************************************************************************
	// MultiAccess�N���X (�}���`�X���b�h���� �o�O���p)
	//****************************************************************************************
	template <typename type> class MultiAccess{
	public:
		MultiAccess();
		MultiAccess(type SetData);
		void Set(type SetData);
		void Add(type Add);
		void Clear();
		type Read();
	private:
		type Data;
	};

	//****************************************************************************************
	// PID�N���X
	//****************************************************************************************
	template <typename type> class PID{
	public:
		PID();
		void Calculation(type SensorVal);
		void SetGain(type _Kp, type _Ki, type _Kd);
		void SetTarget(type Target);
		type Read();
		void Reset();
		void SetLimit(type Limit);

	private:
		type Kp, Ki, Kd;
		type Error, ErrorBefore, ErrorInt;
		type TargetVal;
		type ControlVal;
		type LimitVal;
	};
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X �C���X�g���N�^
//--------------------------------------------------------------------------------------------
template <typename type> OSL::MultiAccess<type>::MultiAccess(){Data = 0;}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X �C���X�g���N�^
// SetData : �i�[����f�[�^
//--------------------------------------------------------------------------------------------
template <typename type> OSL::MultiAccess<type>::MultiAccess(type SetData){Data = SetData;}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X Set�֐�
// SetData : �i�[����f�[�^
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::MultiAccess<type>::Set(type SetData){Data = SetData;}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X Add�֐�
// Add : ���Z����f�[�^
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::MultiAccess<type>::Add(type Add){Data += Add;}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X Clear�֐�
// �i�[����Ă���f�[�^��0�ɂ���
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::MultiAccess<type>::Clear(){Data = 0;}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X Read�֐�
// return : �i�[����Ă���f�[�^
//--------------------------------------------------------------------------------------------
template <typename type> type OSL::MultiAccess<type>::Read(){return Data;}

//--------------------------------------------------------------------------------------------
// Open Source Library
// MultiAccess�N���X �C���X�g���N�^
//--------------------------------------------------------------------------------------------
template <typename type> OSL::PID<type>::PID()
{
	SetTarget(0);
	SetGain(0,0,0);
	SetLimit(1);
	Reset();
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// PID�N���X Calculation�֐�
// SensorVal : �t�B�[�h�o�b�N�����Z���T�l
//
// �������ŌĂяo���Ă�������.
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::PID<type>::Calculation(type SensorVal)
{
	type Ret;
	type P, I, D;

	// �΍��v�Z
	ErrorBefore = Error;				// �O��̕΍����i�[
	Error = TargetVal - SensorVal;		// �΍��v�Z
	ErrorInt += Error;					// �ݐϕ΍�

	// PID�v�Z
	P = Kp * Error;						// ��ᐧ��
	I = Ki * ErrorInt;					// �ϕ�����
	D = Kd * (Error - ErrorBefore);		// ��������

	Ret = P + I + D;

	// ����ʏ���v�Z
	if(LimitVal != 0){
		if(Ret >  LimitVal) Ret = LimitVal;
		if(Ret < -LimitVal) Ret = -LimitVal;
	}

	ControlVal = Ret;
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// PID�N���X SetGain�֐�
// _Kp : ���Q�C��
// _Ki : �ϕ��Q�C��
// _Kd : �����Q�C��
//
// �e�Q�C����ݒ肵�܂�.
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::PID<type>::SetGain(type _Kp, type _Ki, type _Kd)
{
	Kp = _Kp;
	Ki = _Ki;
	Kd = _Kd;
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// PID�N���X SetTarget�֐�
// Target : �ڕW�l
//
// �ڕW�l��ݒ肵�܂�.
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::PID<type>::SetTarget(type Target)
{
	TargetVal = Target;
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// PID�N���X Read�֐�
// return : �����
//--------------------------------------------------------------------------------------------
template <typename type> type OSL::PID<type>::Read()
{
	return ControlVal;
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// PID�N���X Reset�֐�
//
// ���ׂĂ̕΍������������܂�.
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::PID<type>::Reset()
{
	Error = 0;
	ErrorBefore = 0;
	ErrorInt = 0;
}

//--------------------------------------------------------------------------------------------
// Open Source Library
// PID�N���X SetLimit�֐�
// Limit : 0�i����ʐ����Ȃ��j
//       : otherwise(����ʐ�������)
//--------------------------------------------------------------------------------------------
template <typename type> void OSL::PID<type>::SetLimit(type Limit)
{
	LimitVal = Limit;
}

#endif /* OSL_STM32F446_H_ */

//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// end of file
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
